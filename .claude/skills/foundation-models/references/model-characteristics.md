# Apple Foundation Models: モデル特性ガイド

Apple Foundation Models (on-device LLM) の性能特性を実機テストに基づいてまとめたガイド。applefm CLI の開発・利用時の判断基準として活用する。

調査日: 2026-02-08 / 詳細データ: `references/research/01-12*.md`

---

## 1. テキスト生成品質

### 言語別品質

| 言語 | 総合評価 | 強み | 弱み |
|------|---------|------|------|
| 英語 | **A** | 構造的な説明、コード生成 | 事実誤認が散発 (Swift を "Dynamic Typing" と記述) |
| フランス語 | **A-** | 文法・自然さが高い | 固有名詞の関連付けにやや不自然さ |
| スペイン語 | **A-** | 正確で包括的 | — |
| 韓国語 | **B+** | 文法が正しい | 事実の重複 (N Seoul Tower = 南山タワー) |
| ドイツ語 | **B+** | 内容が正確 | 英語混在 ("Charlottenburg Palace") |
| 中国語 | **B** | 基本的に正確 | 不自然な表現 ("天气很漂亮") |
| 日本語 | **B-** | 敬語変換、技術説明 | 事実の正確性に課題、ガードレール過敏 |

### 日本語の既知問題

1. **ガードレールの過度な発動**: 文化的トピック (ことわざ、ランドマーク比較) がブロックされる
2. **事実の不正確さ**: ことわざの意味、地理知識、読み仮名でハルシネーション (「春（スヂマツ）」)
3. **文字数制限の不遵守**: 100文字制限を大幅超過
4. **言語切り替え失敗**: 日本語で「英語で回答して」→ 日本語のまま。英語で "Answer in Japanese" → 成功

### タスク別品質

| タスク | 品質 | 備考 |
|--------|------|------|
| 質問応答 (英語) | A | 正確・簡潔 |
| 概念説明 | A | 構造化された出力 |
| コード生成 | A- | Swift/Python/Bash で実用的。エッジケースのバグに注意 |
| 翻訳 (短文) | B+ | 英語⇔他言語は高品質。文学的翻訳・固有名詞に課題 |
| 要約 | B+ | 構造は良いが事実誤認のリスクあり |
| 敬語変換 | A | 短い変換タスクは非常に得意 |
| 創作 | B | 構造は良いが文字数/音数制限に弱い |
| 論理推論 | B- | 算術は正確、三段論法で誤り |
| 事実質問 (日本語) | C | 無関係な回答が発生する場合あり |

---

## 2. パラメータ特性

### Temperature

| 値 | 挙動 | 用途 |
|----|------|------|
| 0.0 | **完全に決定論的** (再現性100%) | テスト、CI、テンプレート生成 |
| 0.5 | 安定した品質、多様性は低い | 一般的な質問応答 |
| 1.0 | 十分な多様性、品質維持 | 創造的タスクの標準 |
| 1.5 | 冒険的な組み合わせ | ブレスト、複数案生成 |
| 2.0 | **品質が崩壊しない** (Apple FM 固有特性) | 最大の多様性 |

> **重要**: クラウド LLM と異なり、temperature 2.0 でも文法的に正しい出力を維持する。ガードレールが品質の下限を保持している。

### Max-tokens

- 出力トークン数にほぼ線形にレイテンシが比例
- **文の途中でも即座に切断** — 自然な文末停止は行わない
- レイテンシ削減の最も効果的な手段

### Sampling

- `greedy` と `temperature 0.0` は決定論的だが出力が異なる場合がある
- `sampling-threshold` / `sampling-top` の差は微妙 — 大半は temperature のみで十分

### Guardrails と Instructions の関係 (重要)

- **ガードレール問題の真の原因は Instructions の欠如**: `permissive` 単体では Apple 宣伝リダイレクトが解消しない。`permissive` + Instructions の組み合わせで全ケース解決
- Instructions がモデルを「Apple assistant」から「汎用アシスタント」に切り替える決定的要因
- `default` vs `permissive`: 安全なコンテンツでは差なし
- **日本語プロンプトでは `permissive` + Instructions を推奨**
- `permissive` でも Instructions なしでは回避できないブロックあり

### ユースケース別推奨設定

| ユースケース | temperature | max-tokens | guardrails |
|---|---|---|---|
| 再現性が必要 (テスト, CI) | 0.0 | 用途に応じて | default |
| 一般的な質問応答 | デフォルト | デフォルト | default |
| 創造的生成 | 0.8 - 1.2 | デフォルト | default |
| 高い多様性 (ブレスト) | 1.5 - 2.0 | デフォルト | default |
| 構造化データ抽出 | 0.0 | 用途に応じて | default |
| 日本語利用 | デフォルト | デフォルト | **permissive** |

---

## 3. 構造化出力 (Guided Generation)

### スキーマ複雑度別の精度

| 複雑度 | 例 | 精度 |
|--------|-----|------|
| フラットオブジェクト (3-4プロパティ) | `{name, age, active}` | **100%** |
| 1段ネスト + 配列 | `{title, author: {name, email}, tags: [...]}` | **100%** |
| Enum 制約 | `sentiment: "positive" \| "negative" \| "neutral"` | **100%** |
| 配列内オブジェクト (5+プロパティ) | `tasks: [{id, title, priority, ...}]` | **0% (崩壊)** |

### 既知の問題

- **複雑なスキーマで構造崩壊**: 配列内オブジェクトが5プロパティ以上の場合、トップレベルスキーマを再帰的に適用するバグ。`DynamicGenerationSchema` の制約伝達に問題がある可能性
- **数値スケールの不安定性**: `number` 型に範囲制約がないと 0-1 / 0-100 が揺れる

### 推奨事項

1. スキーマは**浅くフラット**に保つ (配列内オブジェクトは 3-4 プロパティまで)
2. 複雑な構造は**分割生成**して組み合わせる
3. **Enum は積極活用** (遵守率100%)
4. 数値には description で範囲を示唆する
5. Instructions で内容の質を制御する

---

## 4. ツール呼び出し

### 精度サマリー

| ツール | 成功率 | 備考 |
|--------|--------|------|
| file-read (明示的指示) | ~80% | "Read the file X" パターンが最安定 |
| shell (明示的コマンド) | ~83% | コマンドをプロンプトに直接含めれば高精度 |
| shell (コマンド自動生成) | ~33% | モデルにコマンド構成を任せると不安定 |
| ツール不要判断 | ~0% | ツールが利用可能だと不要な場面でも呼び出す |

### 推奨プロンプトパターン

```
# file-read (高信頼性)
"Read the file {path} and ..."

# shell (高信頼性)
"Use the shell to run: {exact_command}"

# 避けるべき
"What does {path} contain?"  → ツール呼び出しなし
"How many X files?"          → 不適切なコマンド生成
```

### CLI 改善候補

- ~~file-read エラー時に CLI がクラッシュする~~ → **修正済み (3b0fac3)**: エラーをモデルに返すように変更。全エラーケースで正常動作確認
- Instructions でツール使用の判断基準を明示することで精度向上の可能性
- ツール使用時のコンテキスト制限: **約200行が上限**。大きなファイルで超過エラー

---

## 5. マルチターン会話

### コンテキスト保持

| 項目 | 評価 | 備考 |
|------|------|------|
| Instructions の永続性 | **非常に良好** | 全ターンでペルソナ完全維持 |
| トピック切り替え後の想起 | **非常に良好** | 料理→PG→料理で正確に参照 |
| 技術的コンテキスト | **非常に良好** | プロジェクト名・技術スタックを正確想起 |
| PII の想起 | **ブロック (仕様)** | 名前・住所はガードレール介入 |
| 日本語での保持 | **良好** | 英語と同等 |

### ガードレール介入パターン

| 情報タイプ | 想起 | 結果 |
|-----------|------|------|
| 個人の名前 | "What is my name?" | **ブロック** |
| 職業 | "What do I do?" | 成功 |
| プロジェクト名 | "What project?" | 成功 |
| 技術スタック | "What technologies?" | 成功 |
| 会話内容の要約 | "What sauce?" | 成功 |

> **注意**: ガードレールの発動には非決定的要素がある。無害な数字のやりとりでもブロックされる場合がある (false positive)。

---

## 6. パフォーマンス

### 典型的なレイテンシ

| シナリオ | レイテンシ |
|---------|-----------|
| Cold start | 5-15秒 |
| Warm (短い出力) | 0.3-2秒 |
| Warm (中程度) | 2-5秒 |
| Warm (長い出力) | 10-40秒 |
| 構造化出力 (シンプル) | 2-4秒 |
| 構造化出力 (複雑) | 5-10秒 |
| ツール呼び出し含む | 7-15秒 |

### 推定生成速度

- **ウォーム状態**: 28-57 トークン/秒
- **平均**: ~35 トークン/秒

### パフォーマンスへの影響要因

1. **モデルのメモリ状態** (最大影響): 初回ロード vs キャッシュ状態で数秒〜十数秒の差
2. **出力トークン数**: レイテンシに線形比例。`--max-tokens` が最も効果的な制御手段
3. **ツール呼び出し**: ツールなし比で 20-34倍のレイテンシ増加
4. **OS リソース状態**: 同一条件でも 3-10倍のばらつき
5. **Prewarm の効果は限定的**: ヒントを送るだけでフルロードを保証しない

### 最適化のヒント

- `--max-tokens` で出力を制限 (最も効果的)
- 不要なツールを `--tool` に登録しない
- `--stream` で TTFT (Time-to-First-Token) を改善
- セッション機能で Warm 状態を維持

---

## 7. 実用シナリオ評価

### シナリオ別実用度

| シナリオ | 評価 | 備考 |
|---------|------|------|
| **コードレビュー (単一ファイル)** | **B** | バグ検出 3/3、構造説明は正確。コンテキスト制限で複数ファイル横断は不可 |
| **バグ検出** | **A** | fibonacci return値ミス、ゼロ除算、初期値ミスを全て検出。偽陽性なし |
| **diff 解釈** | **A-** | 変更の「何」と「なぜ」を正しく推論 |
| **コミットメッセージ生成** | **A-** | 構造化出力で正確。ほぼそのまま使える |
| **PR 説明文生成** | **A-** | 簡潔で的確な要約 |
| **Docstring 生成** | **B+** | 正確だが不要な変更を加える傾向 |
| **チェンジログ生成** | **B** | 構造は良いがカテゴリ分類に誤り |
| **README 生成** | **C** | CLI名・オプション名のハルシネーションが深刻 |
| **感情分析** | **A** | 5/5 の精度 |
| **テキスト分類** | **B+** | Bug/Feature/Question の分類は正確 |
| **連絡先情報抽出** | **A-** | 英語・日本語とも高精度 |
| **TODO リスト抽出** | **B** | respond で高精度、generate (配列スキーマ) で失敗 |
| **フォーマット変換** | **A** | JSON→人間可読な要約は優秀 |
| **数値集計・カウント** | **C** | ミスカウントが頻発 |
| **日本語コードレビュー** | **B+** | 自然な日本語で良質 |

### 実用シナリオのキー制約

1. **コンテキスト制限 (~200行)**: ツール使用時に大きなファイルで超過エラー。複数ファイル横断レビューは不可能
2. **ハルシネーション**: CLI名・コマンド名・オプション名を架空のもので埋める傾向。生成結果は必ず人間が確認
3. **配列スキーマの generate 失敗**: `DynamicGenerationSchema` の根本的制約。配列が必要な場合は respond を使用
4. **respond vs generate の使い分け**: 複雑な抽出は respond の方が高精度。generate はフラットなスキーマ限定

---

## 8. 全体的な制限事項

| 制限 | 詳細 | 回避策 |
|------|------|--------|
| Instructions 未設定時の品質低下 | Instructions なしだとモデルが「Apple assistant」モードで応答 | **常に Instructions を設定する** (最重要) |
| 日本語ガードレール過敏 | 文化的トピックがブロックされる | `--guardrails permissive` + Instructions |
| 事実の正確性 | 特に日本語で誤りが頻出 | 事実確認が必要な用途には依存しない |
| 複雑なスキーマ | 配列内オブジェクト / 配列スキーマで崩壊 | スキーマを浅くフラットに。配列は respond で代替 |
| コンテキスト制限 (~200行) | ツール使用時に大ファイルで超過 | ファイル分割、必要部分のみ読み取り |
| Shell コマンド自動生成 | 不安定 | コマンドをプロンプトに直接含める |
| ~~file-read エラー~~ | ~~CLI クラッシュ~~ | **修正済み (3b0fac3)** |
| ツール呼び出し判断 | 不要な場面でもツールを呼ぶ | 不要時は `--tool` を省略 |
| レイテンシのばらつき | 同一条件で 3-10倍 | OS 状態に依存、制御困難 |
| 言語切り替え | 日本語→英語が失敗しやすい | 英語プロンプトから他言語へ切り替える |
| ハルシネーション | CLI名・コマンド名を架空のもので埋める | 生成結果は必ず人間が確認 |
| 数値集計 | カウント・比率計算で誤り頻発 | 数値計算はモデルに任せない |
